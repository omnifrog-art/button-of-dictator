<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Button of Dictator - Trigger</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      background: #0e0e0e;
      color: #ddd;
      font-family: monospace;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      margin: 0;
    }
    h1 {
      font-size: 1.5rem;
      margin-bottom: 1rem;
      color: #fff;
    }
    form, .actions {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      margin-bottom: 2rem;
      width: 250px;
    }
    input, button {
      padding: 0.5rem;
      font-size: 1rem;
      border-radius: 4px;
      border: none;
    }
    input {
      background: #1b1b1b;
      border: 1px solid #444;
      color: #fff;
    }
    button {
      background: #ff4f4f;
      color: #fff;
      cursor: pointer;
    }
    button:hover {
      background: #ff1f1f;
    }
    .small-btn {
      background: #5c5c5c;
    }
    .small-btn:hover {
      background: #777;
    }
  </style>
</head>
<body>

<h1>Button of Dictator</h1>

<form id="username-form">
  <input type="text" id="username" placeholder="Enter your name" required>
  <button type="submit" class="small-btn">Submit Name</button>
</form>

<div class="actions">
  <button id="terminate-btn">Terminate</button>
</div>

<script>
window.addEventListener('DOMContentLoaded', () => {
  const usernameForm = document.getElementById('username-form');
  const usernameInput = document.getElementById('username');
  const terminateBtn = document.getElementById('terminate-btn');

  // 页面加载时记录访问状态
  fetch('/api/update-log', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ action: 'access' })
  }).then(res => res.json())
    .then(data => console.log('Access logged:', data))
    .catch(console.error);

  // 提交用户名
  usernameForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const username = usernameInput.value.trim();
    if (!username) return alert('Please enter your name.');

    try {
      const res = await fetch('/api/update-log', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ username, action: 'assign' })
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.message || 'Assign failed');
      console.log('Name assigned:', data);
      alert('Name recorded successfully.');
    } catch (error) {
      console.error(error);
      alert('Something went wrong: ' + error.message);
    }
  });

  // 点击终结按钮 (流程：terminate -> remove -> 双轮询确认 -> 强制刷新)
  terminateBtn.addEventListener('click', async () => {
    const username = usernameInput.value.trim();
    if (!username) return alert('Please submit your name first.');
    if (!confirm('Are you sure you want to TERMINATE? This action cannot be undone.')) return;

    try {
      // Step 1: Terminate
      const terminateRes = await fetch('/api/update-log', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ username, action: 'terminate' })
      });
      const terminateData = await terminateRes.json();
      if (!terminateRes.ok) throw new Error(terminateData.message || 'Terminate failed');
      console.log('Terminate status updated:', terminateData);

      // 稍微等一下，给Supabase落盘
      await new Promise(resolve => setTimeout(resolve, 500));

      // Step 2: Remove Subdomain
      const removeRes = await fetch('/api/remove-subdomain', {
        method: 'POST'
      });
      const removeData = await removeRes.json();
      if (!removeRes.ok) throw new Error(removeData.message || 'Remove domain failed');
      console.log('Subdomain removed:', removeData);

      alert('Termination command sent. Verifying removal...');

      // Step 3: 双轮询 (确认Supabase和Vercel都处理完毕)
      await waitForFullTermination();

      // Step 4: 强制 reload
      console.log('✅ Fully terminated, reloading...');
      location.reload(true);

    } catch (error) {
      console.error('Termination process failed:', error);
      alert('Something went wrong: ' + error.message);
    }
  });

  // 轮询函数
  async function waitForFullTermination() {
    const maxRetries = 30; // 最多尝试30次
    const interval = 1000; // 每次间隔1秒
    let tries = 0;

    while (tries < maxRetries) {
      tries++;

      try {
        const [domainCheck, logCheck] = await Promise.all([
          fetch('/api/check-subdomain', { method: 'POST' }).then(r => r.json()),
          fetch('/api/check-log-status', { method: 'POST' }).then(r => r.json())
        ]);

        console.log(`[Check #${tries}] domain:`, domainCheck, ' log:', logCheck);

        if (domainCheck?.exists === false && logCheck?.status === 'terminated') {
          return;
        }

      } catch (error) {
        console.error('Polling error:', error);
      }

      await new Promise(resolve => setTimeout(resolve, interval));
    }

    throw new Error('Timeout: Termination confirmation failed.');
  }

});
</script>

</body>
</html>
